#include "modes/note.h"

u8 note_colors[100][3] = {};

int octave = 3; // + - 3
int octave_color[2][3] = {};
int offset = 0; // + - 12
int offset_color[2][3] = {};

u8 finger_grid[5][100] = 
{
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 9, 10, 11, 12, 1, 2, 3, 4, 0, 0, 5, 6, 7, 8, 9, 10, 11, 12, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 9, 10, 11, 12, 1, 2, 3, 4, 5, 0, 0, 6, 7, 8, 9, 10, 11, 12, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 9, 10, 11, 12, 1, 2, 3, 4},
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 3, 4, 5, 6, 7, 8, 9, 10, 0, 0, 5, 6, 7, 8, 9, 10, 11, 12, 0, 0, 7, 8, 9, 10, 11, 12, 1, 2, 0, 0, 9, 10, 11, 12, 1, 2, 3, 4, 0, 0, 11, 12, 1, 2, 3, 4, 5, 6, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 3, 4, 5, 6, 7, 8, 9, 10},
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 4, 5, 6, 7, 8, 9, 10, 11, 0, 0, 7, 8, 9, 10, 11, 12, 1, 2, 0, 0, 10, 11, 12, 1, 2, 3, 4, 5, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 4, 5, 6, 7, 8, 9, 10, 11, 0, 0, 7, 8, 9, 10, 11, 12, 1, 2, 0, 0, 10, 11, 12, 1, 2, 3, 4, 5},
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 5, 6, 7, 8, 9, 10, 11, 12, 0, 0, 9, 10, 11, 12, 1, 2, 3, 4, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 5, 6, 7, 8, 9, 10, 11, 12, 0, 0, 9, 10, 11, 12, 1, 2, 3, 4, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 5, 6, 7, 8, 9, 10, 11, 12},
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 0, 0, 6, 7, 8, 9, 10, 11, 12, 1, 0, 0, 11, 12, 1, 2, 3, 4, 5, 6, 0, 0, 4, 5, 6, 7, 8, 9, 10, 11, 0, 0, 9, 10, 11, 12, 1, 2, 3, 4, 0, 0, 2, 3, 4, 5, 6, 7, 8, 9, 0, 0, 7, 8, 9, 10, 11, 12, 1, 2, 0, 0, 12, 1, 2, 3, 4, 5, 6, 7}
};

u8 raw_note_grid[5][64] = 
{
	{36, 37, 38, 39, 44, 45, 46, 47, 52, 53, 54, 55, 60, 61, 62, 63, 68, 69, 70, 71, 76, 77, 78, 79, 84, 85, 86, 87, 92, 93, 94, 95, 40, 41, 42, 43, 48, 49, 50, 51, 56, 57, 58, 59, 64, 65, 66, 67, 72, 73, 74, 75, 80, 81, 82, 83, 88, 89, 90, 91, 96, 97, 98, 99},
	{36, 37, 38, 39, 38, 39, 40, 41, 40, 41, 42, 43, 42, 43, 44, 45, 44, 45, 46, 47, 46, 47, 48, 49, 48, 49, 50, 51, 50, 51, 52, 53, 40, 41, 42, 43, 42, 43, 44, 45, 44, 45, 46, 47, 46, 47, 48, 49, 48, 49, 50, 51, 50, 51, 52, 53, 52, 53, 54, 55, 54, 55, 56, 57},
	{36, 37, 38, 39, 39, 40, 41, 42, 42, 43, 44, 45, 45, 46, 47, 48, 48, 49, 50, 51, 51, 52, 53, 54, 54, 55, 56, 57, 57, 58, 59, 60, 40, 41, 42, 43, 43, 44, 45, 46, 46, 47, 48, 49, 49, 50, 51, 52, 52, 53, 54, 55, 55, 56, 57, 58, 58, 59, 60, 61, 62, 63, 64},
	{36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71},
	{36, 37, 38, 39, 41, 42, 43, 44, 46, 47, 48, 49, 51, 52, 53, 54, 56, 57, 58, 59, 61, 62, 63, 64, 66, 67, 68, 69, 71, 72, 73, 74, 40, 41, 42, 43, 45, 46, 47, 48, 50, 51, 52, 53, 55, 56, 57, 58, 60, 61, 62, 63, 65, 66, 67, 68, 70, 71, 72, 73, 75, 76, 77, 78}
};

u8 note_midi(u8 p)
{
	return raw_note_grid[finger_set][translate_to_drum(p) - 36] + scale_root;
}

void setNoteLed(u8 p, u8 r, u8 g, u8 b)
{
	note_colors[p][0] = r;
	note_colors[p][1] = g;
	note_colors[p][2] = b;
}

void DrawNotes()
{
	if(chromatic) // Chromatic Mode LED
	{
		for(int i = 0; i < 100; i++)
		{
			for(int x = 0; x < 8; x++)
			{
				if(finger_grid[finger_set][i] == scale_scales[scale][x] + 1)
				{
					u8 out_r = note_r;
					u8 out_g = note_g - 10;
					u8 out_b = note_b;

					if(finger_grid[finger_set][i] == 1)
					{
						out_r = 63; 
						out_g = 0;
						out_b = 63;
					}

					setNoteLed(i, out_r, out_g, out_b);
				}
			}
		}
	}
	else // Scale Mode LED
	{
		for(int i = 0; i < 8; i++)
		{
			if(i == 0)
			{
				
			}
		}
	}


}

void note_init() 
{
	for(int i = 0; i < 100; i++) setNoteLed(i, 0, 0, 0);

	DrawNotes();


	for(int i = 0; i < 64; i++) rgb_out(translate_to_prog(i + 36), note_colors[translate_to_prog(i + 36)][0], note_colors[translate_to_prog(i + 36)][1], note_colors[translate_to_prog(i + 36)][2]);
}

void note_down(u8 p, u8 v)
{
	if(v) rgb_out(p, 0, 63, 0);
		else rgb_out(p, note_colors[p][0], note_colors[p][1], note_colors[p][2]);

	
}

void note_navigation(u8 p, u8 v)
{

}

void note_surface_event(u8 p, u8 v, u8 x, u8 y) 
{
	if(v)
    {
        if(p == 0)
        {
            update(mode_setup);
            return;
        }
    }

	

	if(chromatic)
	{
		u8 e = note_midi(p);

		if(e <= 0 || e >= 127) e = 0;

		hal_send_midi(USBSTANDALONE, 149, e, v);


		if(x >= 1 && x <= 4 && y == 9) note_navigation(p, v);

		if(x >= 1 && x <= 3 && y >= 2 && y <= 8) note_down(p - 5 , v);
		
		if(x >= 6 && x <= 8 && y >= 0 && y <= 7) note_down(p + 5 , v);
	}

	note_down(p, v);
}

void note_midi_event(u8 port, u8 t, u8 ch, u8 p, u8 v) { }

void note_timer_event() {}